<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <link rel="shortcut icon" href="/assets/images/favicon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="../../assets/javascripts/nocollapse.js"></script>
    <title>Contiv</title>

    <link href="/assets/stylesheets/application-37b6ec3f.css" rel="stylesheet"/>

    <!--[if lt IE 9]><script src="/assets/javascripts/html5shiv-ccddc50c.js"></script><script src="/assets/javascripts/respond.min-1eb35b04.js"></script><![endif]-->

    
  </head>

  <body id="page-home" class=" page-home layout-">

<div id="header" class="navbar-static-top">
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
        <div class="navbar-header">
          <div class="navbar-brand">
            <a class="logo" href="/">Contiv</a>
          </div>
          <button class="navbar-toggle" type="button">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="buttons hidden-xs">
          <nav role="navigation">
            <ul class="main-links nav navbar-nav navbar-left">
              <li class="first li-under"><a href="/install/index.html">Documentation</a></li>
              <li class="li-under"><a href="/articles/index.html">Articles</a></li>
            </ul>


            <ul class="nav navbar-nav navbar-right">
                    <li class="li-under"><a href="https://github.com/contiv" target="_blank">
                        
                        <i class="fa fa-github fa-3x"></i>
                        </a></li>
                    <li class="li-under"><a href="https://contiv.slack.com" target="_blank">
                        
                        <i class="fa fa-slack fa-3x"></i>
                        </a></li>
                    <li><a href="https://twitter.com/projectcontiv" target="_blank">
                        <i class="fa fa-twitter fa-3x"></i>
                        </a></li>
            </ul>
          
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="sidebar-overlay"></div>


<aside id="sidebar" class="sidebar sidebar-default sidebar-fixed-right" role="navigation">
    
    <div class="sidebar-header header-cover">
        
        <div class="sidebar-image">
            <img src="/assets/images/logo-header@2x.png" width="49px" height="56px">
        </div>
    </div>

    
    <ul class="main nav sidebar-nav">
        <li class="first"><a href="/intro/index.html">Intro</a></li>
        <li class=""><a href="/docs/index.html">Docs</a></li>
    </ul>
    <div class="divider"></div>
    
    <ul class="external nav sidebar-nav">
        <li class=""><a class="v-btn gray sml" href="https://github.com/contiv"><svg id="svg-download" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" style="enable-background:new 0 0 14 14;">
  <style>
  </style>
  <path class="" d="M13,0H1C0.5,0,0,0.5,0,1v12c0,0.5,0.5,1,1,1h4.7c0,0,0,0,0-0.1c0-0.2,0-0.6,0-1.1c-1.8,0.4-2.2-0.9-2.2-0.9
    c-0.3-0.8-0.7-1-0.7-1c-0.6-0.4,0-0.4,0-0.4c0.7,0,1,0.7,1,0.7c0.6,1,1.5,0.7,1.9,0.5c0.1-0.4,0.2-0.7,0.4-0.9c-1.5-0.2-3-0.7-3-3.2
    c0-0.7,0.3-1.3,0.7-1.8C3.7,5.8,3.5,5.1,3.9,4.2c0,0,0.6-0.2,1.8,0.7c0.5-0.1,1.1-0.2,1.6-0.2c0.6,0,1.1,0.1,1.6,0.2
    c1.3-0.8,1.8-0.7,1.8-0.7c0.4,0.9,0.1,1.6,0.1,1.7c0.4,0.5,0.7,1,0.7,1.8c0,2.5-1.5,3.1-3,3.2C8.7,11.1,9,11.5,9,12.1
    c0,0.9,0,1.6,0,1.8c0,0,0,0,0,0.1h4c0.5,0,1-0.5,1-1V1C14,0.5,13.5,0,13,0z"/>
</svg>
GitHub</a></li>
    </ul>
</aside>


<h1>volplugin</h1>
<p>Contiv Volume plugin <a title="Title" href="https://github.com/contiv/volplugin">volplugin</a>
is a Ceph volume driver, and policy system that works well within a Docker
ecosystem. It can automatically move your storage with your containers, rather
than pinning containers to specific hosts to take advantage of their storage.</p>

<h2>Getting started</h2>
<p>Getting started describes setting up a test environment with three VMs. Once
the test environment is setup see the <a href="#Configure Services"><strong>Configure Services</strong></a>.</p>

<h4>Prerequisites</h4>
<p>Please read and follow the instructions in the prerequisites section of the
volplugin
<a href="https://github.com/contiv/volplugin/blob/master/README.md#prerequisites">README</a>
before completing the following:</p>

<h3>Clone and build the project</h3>

<h3>On Linux (without a VM)</h3>
<p>Clone the project:</p>
<pre class="highlight plaintext"><code>git clone https://github.com/contiv/volplugin
</code></pre>
<p>Build the project:</p>
<pre class="highlight plaintext"><code>make run-build
</code></pre>
<p>The command <code>make run-build</code> installs utilities for building the software in
the <code>$GOPATH</code>, as well as the <code>volmaster</code>, <code>volplugin</code> and <code>volcli</code> utilities.</p>

<h3>Everywhere else (with a VM):</h3>
<p>Clone the project:</p>
<pre class="highlight plaintext"><code>git clone https://github.com/contiv/volplugin
</code></pre>
<p>Build the project:</p>
<pre class="highlight plaintext"><code>make start
</code></pre>
<p>The build and binaries will be on the VM in the following directory <code>/opt/golang/bin</code>.</p>

<h2>Do it yourself</h2>

<h3>Installing Dependencies</h3>
<p>Use the Contiv <a href="https://github.com/contiv/volplugin/releases">nightly releases</a>
when following these steps:</p>
<p><strong>Note:</strong> Using the nightly builds is simpler than building the applications.</p>
<p>Install the dependencies in the following order:</p>

<ol>
<li><p>Follow the <a href="https://github.com/coreos/etcd/releases/tag/v2.2.0">Getting Started</a> to install <a href="https://coreos.com/etcd/docs/latest/getting-started-with-etcd.html">Etcd</a>.</p>

<ul>
<li>Currently versions 2.0 and later are supported.
</li>
</ul>
</li>
<li><p>Follow the <a href="http://docs.ceph.com/docs/master/install/">Ceph Installation Guide</a> to install <a href="http://ceph.com">Ceph</a>.</p>
</li>
<li><p>Configure Ceph with <a href="https://github.com/ceph/ceph-ansible">Ansible</a>.</p>
</li>
</ol>
<p><strong>Note</strong>: See the <a href="https://github.com/contiv/volplugin/blob/master/README.md#running-the-processes">README</a>
  for pre-configured VMs that work on any UNIX operating system to simplify
    Ceph installation.</p>

<ol>
<li><p>Upload a global configuration. You can find an example one <a href="https://github.com/contiv/volplugin/blob/master/systemtests/testdata/global1.json">here</a></p>
</li>
<li><p>Start volmaster in debug mode (as root):</p>
</li>
</ol>
<pre class="highlight plaintext"><code>volmaster &amp;
</code></pre>
<p><strong>Note</strong>: volmaster debug mode is very noisy and is not recommended. Therefore,
avoid using it with background processes. volplugin currently connects to
volmaster using port 9005, however in the future it is variable.</p>

<ol>
<li>Start volsupervisor (as root):
</li>
</ol>
<pre class="highlight plaintext"><code>volsupervisor &amp;
</code></pre>
<p><strong>Note</strong>: volsupervisor debug mode is very noisy and is not recommended.</p>

<ol>
<li> Start volplugin in debug mode (as root):
</li>
</ol>
<pre class="highlight plaintext"><code>volplugin &amp;
</code></pre>
<p>If running volplugin on multiple hosts, use the <code>--master</code> flag to
provide a ip:port pair to connect to over http. By default it connects to
<code>127.0.0.1:9005</code>.</p>

<h2>Configure Services</h2>
<p>Ensure Ceph is fully operational, and that the <code>rbd</code> tool works as root.</p>
<p>Upload a policy:</p>
<pre class="highlight plaintext"><code>volcli policy upload policy1
</code></pre>
<p><strong>Note</strong>: It accepts the policy from stdin, e.g.: <code>volcli policy upload policy1 &lt; mypolicy.json</code>
Examples of a policy are in <a href="https://github.com/contiv/volplugin/tree/master/systemtests/testdata">systemtests/testdata</a>.</p>

<h3>Creating a container with a volume</h3>
<p>Create a volume that refers to the volplugin driver:</p>
<pre class="highlight plaintext"><code>docker volume create -d volplugin --name policy1/test
</code></pre>
<p><strong>Notes</strong>:</p>

<ul>
<li><a name="test"/><a href="#test"><code>test</code></a> is the name of the volume, and is located under policy <code>policy1</code>,
which is uploaded with <code>volcli policy upload.</code>
</li>
<li>The volume will inherit the properties of the policy. Therefore, the
volume will be of appropriate size, iops, etc.
</li>
<li>There are numerous options (see below) to declare overrides of most parameters in the policy configuration.
</li>
<li>Run a container that uses the policy:
</li>
</ul>
<pre class="highlight plaintext"><code>docker run -it -v policy1/test:/mnt ubuntu bash
</code></pre>

<ul>
<li>Run <a name="mount_grep_mnt"/><a href="#mount_grep_mnt"><code>mount | grep /mnt</code></a> in the container.
</li>
</ul>
<p><strong>Note</strong>: <code>/dev/rbd#</code>should be attached to that directory.</p>

<ul>
<li>Once a multi-host system is setup, anytime the volume is not mounted, it
can be mounted on any host that has a connected rbd client available, and
volplugin running.
</li>
</ul>